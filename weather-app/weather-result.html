<!DOCTYPE html>
<html lang="pt-BR" class="transition-colors duration-500">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Resultado do Clima</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      transition: background-color 0.5s, color 0.5s;
    }
    .spinner {
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid white;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .dark body {
      background: #1a202c;
      color: #cbd5e0;
    }
    .dark .bg-white {
      background-color: #2d3748 !important;
    }
    .dark .bg-indigo-700 {
      background-color: #4c51bf !important;
    }
    .dark .bg-indigo-800:hover {
      background-color: #434190 !important;
    }
    .dark .bg-gray-600 {
      background-color: #4a5568 !important;
    }
    .dark .bg-gray-700:hover {
      background-color: #2d3748 !important;
    }
    .dark .bg-green-600 {
      background-color: #38a169 !important;
    }
    .dark .bg-green-700:hover {
      background-color: #2f855a !important;
    }
  </style>
</head>
<body class="bg-gradient-to-r from-blue-400 to-indigo-600 min-h-screen flex items-center justify-center p-4" aria-live="polite">
  <div class="bg-white bg-opacity-20 backdrop-blur-md rounded-xl shadow-lg max-w-md w-full p-6" role="main">
    <h1 class="text-white text-3xl font-semibold mb-6 text-center" id="resultTitle">Resultado do Clima</h1>
    <div id="weatherResult" class="text-white text-center space-y-4 opacity-100" role="region" aria-live="polite" aria-atomic="true">
      <div class="spinner"></div>
      <p>Carregando...</p>
    </div>
    <button
      id="backBtn"
      class="mt-6 w-full bg-gray-800 hover:bg-gray-900 text-white py-2 rounded-md transition"
      aria-label="Voltar para busca"
    >
      <i class="fas fa-arrow-left mr-2" aria-hidden="true"></i> Voltar
    </button>
  </div>

  <script>
    const weatherResult = document.getElementById('weatherResult');
    const backBtn = document.getElementById('backBtn');
    const htmlElement = document.documentElement;

    function displayError(message) {
      weatherResult.innerHTML = `<p class="text-red-300">${message}</p>`;
    }

    function displayWeather(data, locationName) {
      weatherResult.innerHTML = `
        <h2 class="text-2xl font-semibold">${locationName}</h2>
        <p class="text-xl capitalize">${data.weathercode_description}</p>
        <p class="text-4xl font-bold">${data.temperature}°C</p>
        <p>Vento: ${data.windspeed} km/h</p>
        <p>Umidade relativa: ${data.relativehumidity}%</p>
        <p>Pressão atmosférica: ${data.pressure} hPa</p>
      `;
    }

    function getQueryParam(param) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(param);
    }

    async function fetchCoordinates(city) {
      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(city)}`;
      const response = await fetch(url);
      if (!response.ok) {
        throw new Error('Erro ao buscar coordenadas');
      }
      const data = await response.json();
      if (data.length === 0) {
        throw new Error('Cidade não encontrada');
      }
      return {
        lat: data[0].lat,
        lon: data[0].lon,
        display_name: data[0].display_name
      };
    }

    async function fetchWeather(lat, lon) {
      const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&hourly=relativehumidity_2m,pressure_msl&temperature_unit=celsius&windspeed_unit=kmh&timezone=auto`;
      const response = await fetch(url);
      if (!response.ok) {
        throw new Error('Erro ao buscar dados do clima');
      }
      const data = await response.json();
      if (!data.current_weather) {
        throw new Error('Dados do clima indisponíveis');
      }
      return data.current_weather;
    }

    async function getWeatherByCity(city) {
      try {
        const coords = await fetchCoordinates(city);
        const weather = await fetchWeather(coords.lat, coords.lon);
        // Map weathercode to description
        const weatherDescriptions = {
          0: 'Céu limpo',
          1: 'Principalmente limpo',
          2: 'Parcialmente nublado',
          3: 'Nublado',
          45: 'Neblina',
          48: 'Neblina com cristais de gelo',
          51: 'Chuvisco leve',
          53: 'Chuvisco moderado',
          55: 'Chuvisco denso',
          56: 'Chuvisco congelante leve',
          57: 'Chuvisco congelante denso',
          61: 'Chuva leve',
          63: 'Chuva moderada',
          65: 'Chuva forte',
          66: 'Chuva congelante leve',
          67: 'Chuva congelante forte',
          71: 'Neve leve',
          73: 'Neve moderada',
          75: 'Neve forte',
          77: 'Granizo',
          80: 'Chuva de pancadas leve',
          81: 'Chuva de pancadas moderada',
          82: 'Chuva de pancadas forte',
          85: 'Neve de pancadas leve',
          86: 'Neve de pancadas forte',
          95: 'Tempestade com trovoadas',
          96: 'Tempestade com trovoadas e granizo leve',
          99: 'Tempestade com trovoadas e granizo forte'
        };
        weather.weathercode_description = weatherDescriptions[weather.weathercode] || 'Desconhecido';
        displayWeather(weather, coords.display_name);
      } catch (error) {
        displayError(error.message);
      }
    }

    async function getWeatherByCoords(lat, lon) {
      try {
        const weather = await fetchWeather(lat, lon);
        // Reverse geocode to get location name
        const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`;
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error('Erro ao buscar nome da localização');
        }
        const data = await response.json();
        const locationName = data.display_name || `${lat}, ${lon}`;
        // Map weathercode to description
        const weatherDescriptions = {
          0: 'Céu limpo',
          1: 'Principalmente limpo',
          2: 'Parcialmente nublado',
          3: 'Nublado',
          45: 'Neblina',
          48: 'Neblina com cristais de gelo',
          51: 'Chuvisco leve',
          53: 'Chuvisco moderado',
          55: 'Chuvisco denso',
          56: 'Chuvisco congelante leve',
          57: 'Chuvisco congelante denso',
          61: 'Chuva leve',
          63: 'Chuva moderada',
          65: 'Chuva forte',
          66: 'Chuva congelante leve',
          67: 'Chuva congelante forte',
          71: 'Neve leve',
          73: 'Neve moderada',
          75: 'Neve forte',
          77: 'Granizo',
          80: 'Chuva de pancadas leve',
          81: 'Chuva de pancadas moderada',
          82: 'Chuva de pancadas forte',
          85: 'Neve de pancadas leve',
          86: 'Neve de pancadas forte',
          95: 'Tempestade com trovoadas',
          96: 'Tempestade com trovoadas e granizo leve',
          99: 'Tempestade com trovoadas e granizo forte'
        };
        weather.weathercode_description = weatherDescriptions[weather.weathercode] || 'Desconhecido';
        displayWeather(weather, locationName);
      } catch (error) {
        displayError(error.message);
      }
    }

    function getQueryParam(param) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(param);
    }

    function init() {
      const city = getQueryParam('city');
      const lat = getQueryParam('lat');
      const lon = getQueryParam('lon');

      if (city) {
        getWeatherByCity(city);
      } else if (lat && lon) {
        getWeatherByCoords(lat, lon);
      } else {
        displayError('Parâmetros de localização ausentes.');
      }
    }

    backBtn.addEventListener('click', () => {
      window.location.href = 'index.html';
    });

    // Dark mode toggle logic
    function setDarkMode(enabled) {
      if (enabled) {
        htmlElement.classList.add('dark');
        localStorage.setItem('darkMode', 'enabled');
      } else {
        htmlElement.classList.remove('dark');
        localStorage.setItem('darkMode', 'disabled');
      }
    }

    // Initialize dark mode based on saved preference
    if (localStorage.getItem('darkMode') === 'enabled') {
      setDarkMode(true);
    }

    init();
  </script>
</body>
</html>
